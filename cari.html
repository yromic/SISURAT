<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cari Surat | Arsip</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #eeeeee;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #393e46;
      }
      ::-webkit-scrollbar-thumb {
        background: #00adb5;
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="flex text-[#222831]">
    <aside
      class="w-64 h-screen bg-[#222831] text-[#EEEEEE] shadow-lg sticky top-0 flex flex-col"
    >
      <div class="p-6">
        <h2 class="text-2xl font-bold tracking-wide flex items-center gap-2">
          <i class="fas fa-folder-open text-[#00ADB5]"></i> Arsip
        </h2>
      </div>
      <nav class="flex-1 px-4">
        <ul class="space-y-2">
          <li>
            <a
              href="dashboard.html"
              class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-[#393E46] hover:text-white transition-all duration-200"
            >
              <i class="fas fa-chart-pie w-5"></i> Dashboard
            </a>
          </li>
          <li>
            <a
              href="cari.html"
              class="flex items-center gap-3 px-4 py-3 rounded-lg bg-[#00ADB5] text-white font-semibold shadow-md"
            >
              <i class="fas fa-search w-5"></i> Cari
            </a>
          </li>
          <li>
            <a
              href="#"
              class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-[#393E46] hover:text-white transition-all duration-200"
            >
              <i class="fas fa-database w-5"></i> Master Data
            </a>
          </li>
          <li>
            <a
              href="#"
              class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-[#393E46] hover:text-white transition-all duration-200"
            >
              <i class="fas fa-bars w-5"></i> Menu Lain
            </a>
          </li>
        </ul>
      </nav>
      <div class="p-4 border-t border-[#393E46] mt-auto">
        <button
          onclick="logout()"
          class="w-full flex items-center justify-center gap-2 bg-[#393E46] hover:bg-[#00ADB5] text-white px-4 py-2 rounded-lg transition-colors duration-200"
        >
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-[#222831] flex items-center gap-3">
          <i class="fas fa-search text-[#00ADB5]"></i> Cari Surat
        </h1>
        <div class="flex items-center gap-4">
          <span
            class="text-sm text-[#393E46] bg-white px-4 py-2 rounded-full shadow-sm"
          >
            <i class="fas fa-user-circle text-[#00ADB5] mr-1"></i>
            <span id="user-name" class="font-semibold">User</span>
          </span>
        </div>
      </div>

      <div class="flex gap-3 mb-5">
        <div class="relative flex-1">
          <i
            class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-[#393E46]"
          ></i>
          <input
            id="search"
            type="text"
            placeholder="Cari surat, nomor, perihal..."
            class="w-full pl-12 pr-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-[#00ADB5] bg-white shadow-md"
          />
        </div>
        <button
          onclick="toggleFilter()"
          class="bg-[#393E46] hover:bg-[#4a525c] text-white px-5 py-3 rounded-xl shadow-md transition flex items-center gap-2"
        >
          <i class="fas fa-sliders-h"></i> Filter
        </button>
      </div>

      <div
        id="filterPanel"
        class="hidden bg-white p-5 rounded-xl shadow-lg mb-6 border-l-4 border-[#00ADB5] transition-all"
      >
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-[#393E46] mb-1"
              ><i class="fas fa-tag mr-1 text-[#00ADB5]"></i>Jenis</label
            >
            <select
              id="jenis"
              class="w-full border border-[#DDD] rounded-lg p-2 focus:border-[#00ADB5] focus:ring-1 focus:ring-[#00ADB5]"
            >
              <option value="">Semua</option>
              <option value="db_surat_masuk">Surat Masuk</option>
              <option value="db_surat_keluar">Surat Keluar</option>
              <option value="db_piagam">Piagam</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-[#393E46] mb-1"
              ><i class="fas fa-calendar-alt mr-1 text-[#00ADB5]"></i
              >Dari</label
            >
            <input
              type="date"
              id="from"
              class="w-full border border-[#DDD] rounded-lg p-2 focus:border-[#00ADB5] focus:ring-1 focus:ring-[#00ADB5]"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-[#393E46] mb-1"
              ><i class="fas fa-calendar-check mr-1 text-[#00ADB5]"></i
              >Sampai</label
            >
            <input
              type="date"
              id="to"
              class="w-full border border-[#DDD] rounded-lg p-2 focus:border-[#00ADB5] focus:ring-1 focus:ring-[#00ADB5]"
            />
          </div>
        </div>
        <div class="flex justify-end mt-4 gap-2">
          <button
            onclick="resetFilter()"
            class="px-4 py-2 text-sm bg-[#EEEEEE] hover:bg-gray-200 rounded-lg transition flex items-center gap-1"
          >
            <i class="fas fa-undo-alt"></i> Reset
          </button>
          <button
            onclick="runSearch()"
            class="px-4 py-2 text-sm bg-[#00ADB5] hover:bg-[#00939c] text-white rounded-lg transition flex items-center gap-1"
          >
            <i class="fas fa-search"></i> Terapkan
          </button>
        </div>
      </div>

      <div class="flex items-center justify-between mb-4">
        <p class="text-sm text-[#393E46]">
          <i class="fas fa-file-alt mr-1"></i>
          <span id="result-count">0</span> hasil ditemukan
        </p>
        <div class="flex gap-1">
          <button
            class="w-8 h-8 rounded bg-[#00ADB5] text-white flex items-center justify-center"
          >
            <i class="fas fa-th"></i>
          </button>
          <button
            class="w-8 h-8 rounded bg-white text-[#393E46] hover:bg-[#EEEEEE] flex items-center justify-center"
          >
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>

      <div
        id="result"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"
      >
        <div class="col-span-full text-center py-10 text-[#393E46]">
          <i class="fas fa-circle-notch fa-spin text-3xl text-[#00ADB5]"></i>
          <p class="mt-2">Memuat data...</p>
        </div>
      </div>
    </main>

    <div
      id="modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl flex flex-col md:flex-row relative overflow-hidden"
      >
        <button
          onclick="closeModal()"
          class="absolute top-4 right-4 text-[#393E46] hover:text-[#00ADB5] transition z-10 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-md"
        >
          <i class="fas fa-times text-xl"></i>
        </button>

        <div
          class="w-full md:w-1/2 p-6 max-h-[70vh] overflow-y-auto bg-[#F9F9F9]"
        >
          <h2
            class="text-2xl font-bold text-[#222831] mb-4 flex items-center gap-2"
          >
            <i class="fas fa-info-circle text-[#00ADB5]"></i> Detail Surat
          </h2>
          <div id="detail" class="space-y-3 text-sm"></div>
        </div>

        <div class="w-full md:w-1/2 bg-[#222831] flex flex-col">
          <div
            class="p-3 bg-[#393E46] text-white flex items-center justify-between"
          >
            <span class="font-medium"
              ><i class="fas fa-file-pdf mr-2"></i>Pratinjau</span
            >
            <a
              id="download-link"
              href="#"
              target="_blank"
              class="text-[#00ADB5] hover:underline text-sm flex items-center gap-1"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>
          <iframe
            id="preview"
            class="flex-1 w-full min-h-[400px]"
            frameborder="0"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL =
        "https://script.google.com/macros/s/AKfycbyey9N4Wcy1RsMAsxk0CxE_wNIaAAB9Ks1QHz6srF1i4qKQthyiHf2tRtAyE78Ygwjn/exec";

      (function checkAuth() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user && window.location.pathname.includes("cari.html")) {
          window.location.href = "index.html";
        } else if (user) {
          document.getElementById("user-name").innerText =
            user.username || "User";
        }
      })();

      async function fetchData(table) {
        try {
          const res = await fetch(`${BASE_URL}?action=get_data&table=${table}`);
          const result = await res.json();
          return result.data || [];
        } catch (error) {
          console.error(`Gagal mengambil data dari ${table}:`, error);
          return [];
        }
      }

      async function loadAll() {
        const masuk = await fetchData("db_surat_masuk");
        const keluar = await fetchData("db_surat_keluar");
        const piagam = await fetchData("db_piagam");

        masuk.forEach((d) => {
          d.jenis = "Surat Masuk";
          d.tanggal = d.timestamp || d.tanggal_surat || "";
        });

        keluar.forEach((d) => {
          d.jenis = "Surat Keluar";
          d.tanggal = d.timestamp || d.tanggal_surat || "";
        });

        piagam.forEach((d) => {
          d.jenis = "Piagam";
          d.tanggal = d.timestamp || d.tahun_perlombaan || "";
        });

        return [...masuk, ...keluar, ...piagam];
      }

      function render(data) {
        const container = document.getElementById("result");
        const countSpan = document.getElementById("result-count");
        countSpan.innerText = data.length;

        if (data.length === 0) {
          container.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-folder-open text-5xl text-[#00ADB5] opacity-30 mb-3"></i>
            <p class="text-[#393E46] text-lg">Tidak ada data ditemukan</p>
          </div>
        `;
          return;
        }

        container.innerHTML = data
          .map((item) => {
            let icon = "fa-file";
            if (item.jenis === "Surat Masuk") icon = "fa-inbox";
            else if (item.jenis === "Surat Keluar") icon = "fa-paper-plane";
            else if (item.jenis === "Piagam") icon = "fa-award";

            const judul =
              item.perihal || item.jenis_perlombaan || item.nama || "-";
            const nomor = item.nomor_surat || "-";
            const tanggal = item.tanggal_surat || item.tahun_perlombaan || "-";

            return `
          <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition p-5 border-l-4 border-[#00ADB5] flex flex-col">
            <div class="flex items-start gap-3 mb-3">
              <div class="bg-[#00ADB5] bg-opacity-10 p-3 rounded-full">
                <i class="fas ${icon} text-[#00ADB5] text-xl"></i>
              </div>
              <div class="flex-1">
                <span class="text-xs font-medium px-2 py-1 bg-[#393E46] text-white rounded-full">${item.jenis}</span>
                <h3 class="font-bold text-[#222831] mt-2 line-clamp-2">${judul}</h3>
              </div>
            </div>
            <div class="text-sm text-[#393E46] space-y-1 mb-4">
              <p><i class="fas fa-hashtag w-4 text-[#00ADB5]"></i> ${nomor}</p>
              <p><i class="fas fa-calendar-alt w-4 text-[#00ADB5]"></i> ${tanggal}</p>
            </div>
            <div class="flex gap-2 mt-auto">
              <button onclick='showDetail(${JSON.stringify(item).replace(/'/g, "\\'")})' 
                class="flex-1 bg-[#00ADB5] hover:bg-[#00939c] text-white px-3 py-2 rounded-lg text-sm transition flex items-center justify-center gap-1">
                <i class="fas fa-eye"></i> Detail
              </button>
              <a href="${item.upload_file || item.ttd_pengambil || "#"}" target="_blank"
                class="flex-1 bg-[#393E46] hover:bg-[#4a525c] text-white px-3 py-2 rounded-lg text-sm transition flex items-center justify-center gap-1">
                <i class="fas fa-download"></i> Unduh
              </a>
            </div>
          </div>
        `;
          })
          .join("");
      }

      async function runSearch() {
        let data = await loadAll();

        const keyword = document.getElementById("search").value.toLowerCase();
        const jenis = document.getElementById("jenis").value;
        const from = document.getElementById("from").value;
        const to = document.getElementById("to").value;

        if (jenis) {
          data = data.filter((d) => {
            if (jenis === "db_surat_masuk") return d.jenis === "Surat Masuk";
            if (jenis === "db_surat_keluar") return d.jenis === "Surat Keluar";
            if (jenis === "db_piagam") return d.jenis === "Piagam";
          });
        }

        if (from) {
          data = data.filter((d) => new Date(d.tanggal) >= new Date(from));
        }
        if (to) {
          data = data.filter((d) => new Date(d.tanggal) <= new Date(to));
        }

        if (keyword) {
          data = data.filter((d) =>
            JSON.stringify(d).toLowerCase().includes(keyword),
          );
        }

        data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

        render(data);
      }

      function showDetail(data) {
        const detail = document.getElementById("detail");
        const preview = document.getElementById("preview");
        const downloadLink = document.getElementById("download-link");

        let html = "";
        for (let key in data) {
          if (
            key === "jenis" ||
            key === "tanggal" ||
            key === "upload_file" ||
            key === "ttd_pengambil"
          )
            continue;
          html += `
          <div class="flex border-b border-gray-200 py-2">
            <span class="w-1/3 font-medium text-[#393E46]">${key}</span>
            <span class="w-2/3 text-[#222831]">${data[key] || "-"}</span>
          </div>
        `;
        }
        detail.innerHTML = html;

        const fileUrl = data.upload_file || data.ttd_pengambil || "";
        downloadLink.href = fileUrl;

        if (fileUrl) {
          let matchId =
            fileUrl.match(/id=([^&]+)/) || fileUrl.match(/d\/([a-zA-Z0-9-_]+)/);

          if (matchId && matchId[1]) {
            let fileId = matchId[1];

            preview.src = `https://drive.google.com/file/d/${fileId}/preview`;
          } else {
            preview.src = fileUrl;
          }
        } else {
          preview.src = "";
        }

        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      function toggleFilter() {
        document.getElementById("filterPanel").classList.toggle("hidden");
      }

      function resetFilter() {
        document.getElementById("search").value = "";
        document.getElementById("jenis").value = "";
        document.getElementById("from").value = "";
        document.getElementById("to").value = "";
        runSearch();
      }

      function logout() {
        localStorage.removeItem("user");
        window.location.href = "index.html";
      }

      document.getElementById("search").addEventListener("input", runSearch);
      document.getElementById("jenis").addEventListener("change", runSearch);
      document.getElementById("from").addEventListener("change", runSearch);
      document.getElementById("to").addEventListener("change", runSearch);

      window.onload = runSearch;
    </script>
  </body>
</html>
